{% extends 'base.html' %}

{% block main %}
<div class="mt-5 mb-3">
    <h1 class="font-medium text-xl text-[#F3209D] ">นัดหมาย</h1>
</div>
<div class="flex flex-wrap gap-x-8">
    <div class="bg-white p-8 rounded-lg border border-[#7469B6] w-1/4 shadow-md">
        <h2 class="text-lg  text-center mb-2 text-[#7B42C4]">จำนวนนัดหมายวันนี้</h2>
        <h2 class="text-lg text-center"> {{ appointment_count_today }}</h2>
    </div>
    <a href="{% url 'appointment-list' %}" class="bg-white p-8 rounded-lg border border-[#7469B6] w-1/4 shadow-md">
        <h2 class="text-lg  text-center mb-2 text-[#7B42C4]">จำนวนนัดหมายทั้งหมด</h2>
        <h2 class="text-lg text-center"> {{ appointment_count }}</h2>
    </a>
</div>
<div class=" my-5">
    <a  href="#" onclick="openAddModal()" class="btn bg-[#7B42C4] text-white hover:bg-[#7469B6]">เพิ่มนัดหมาย</a>
    <a  href="{% url 'appointment-add-braces' %}"  class="btn bg-[#7B42C4] text-white hover:bg-[#7469B6]">เพิ่มนัดหมายจัดฟัน</a>
    <a  href="{% url 'calendar' %}" class="btn bg-[#7B42C4] text-white hover:bg-[#7469B6]">ปฏิทิน</a>
</div>
<div class="mt-5 mb-3">
  <h1 class="font-medium text-xl text-[#F3209D] ">นัดหมายวันนี้</h1>
</div>
<!-- Modal เพิ่ม-->
<div id="addModal" class="fixed inset-0 flex items-center justify-center z-50 hidden bg-gray-500 bg-opacity-50">
  <div class="w-1/3 max-w-md">
      <div class="bg-white p-6 rounded-lg shadow-lg w-full">
        <h3 class="text-xl font-semibold mb-4">นัดหมาย</h3>
        <p>คุณต้องการเพิ่มการนัดหมายนี้หรือไม่?</p>
        <form id="addForm" method="POST" >
          {% csrf_token %}
          <div class="mt-4">
                    <label for="user">ชื่อคนไข้</label><br>
                    <select type="text" id="user" name="user" required class="select select-bordered w-full  my-1" >
                        <option value="" disabled selected>เลือกคนไข้</option> 
                            {% for user in users %}
                                <option value="{{user.id}}">{{user.title}}{{user.first_name}} {{user.last_name}}</option>
                            {% endfor %}
                    </select><br>

                    <label for="dentist">ชื่อทันตแพทย์</label><br>
                      <select type="text" id="dentist" name="dentist" required class="select select-bordered w-full my-1" >
                          <option value="" disabled selected>เลือกทันตแพทย์</option> 
                              {% for dentist in dentists %}
                                  <option value="{{dentist.id}}">{{dentist.dentistName}}</option>
                              {% endfor%}
                      </select><br>

                    <label for="treatment">รายการนัดหมาย</label><br>
                    <select type="text" id="treatment" name="treatment" required class="select select-bordered w-full  my-1" >
                        <option value="" disabled selected>เลือกรายการ</option> 
                            {% for treatment in treatments %}
                                <option value="{{treatment.id}}">{{treatment.treatmentName}}</option>
                            {% endfor%}
                    </select><br>

                    <label for="date">วันที่นัดหมาย</label><br>
                    <input type="date" id="date" name="date" required class="input input-bordered w-full my-1" /><br>
                
                    <!-- เพิ่ม Dropdown สำหรับ Time Slot -->
                    <label for="time_slot">เวลา</label><br>
                    <select id="time_slot" name="time_slot" required class="select select-bordered w-full   my-1">
                        <option value="">เลือกเวลา</option>
                    </select> <br>

                    <div class="mt-4 flex justify-end">
                      <button type="submit" class="btn btn-neutral mr-2">บันทึกการนัดหมาย</button>
                      <button type="button" class="btn btn-ghost " onclick="closeAddModal()">ยกเลิก</button>
                    </div>
          </div>
        </form>
      </div>
    </div>
</div>

<div class="bg-white p-8 rounded-lg border border-[#7469B6]">
    <div class="overflow-x-auto">
        <table class="table">
          <!-- head -->
          <thead>
            <tr>
              <th>ชื่อ</th>
              <th>รายการ</th>
              <th>วัน</th>
              <th>เวลา</th>
              <th>สถานะ</th>
              <th>ตัวเลือก</th>
            </tr>
          </thead>
          <tbody>
            {% for appointment in page_obj %}
            <!-- row 1 -->
            <tr>
              <td>
                <div class="flex items-center gap-3">
                  <div class="avatar">
                    <div class="mask mask-squircle h-12 w-12">
                      <img
                        src="{{appointment.user.profile.image.url}}"
                        alt="รูปโปรไฟล์ของผู้ใช้" />
                    </div>
                  </div>
                  <div>
                    <div class="font-bold">{{appointment.user.title}}{{appointment.user.first_name}} {{appointment.user.last_name}}</div>
                    <div class="text-sm opacity-50">{{appointment.user.profile.phone}}</div>
                  </div>
                </div>
              </td>
              <td>
                {% if appointment.detail %}
                {{appointment.detail}} {{appointment.treatment}}
                {% else %}
                {{appointment.treatment}}
                {% endif %}
                <br />
                <span class="badge badge-ghost badge-sm">{{appointment.dentist}}</span>
              </td>
              <td>{{appointment.date|date:"j F Y"}}</td>
              <th>
                <button class="btn btn-ghost btn-xs">{{appointment.time_slot|time:"H:i"}}</button>
              </th>
              <th>
                <button class="btn btn-ghost btn-xs">{{appointment.status}}</button>
              </th>
              <th>
                <a href="{% url 'appointment-edit' appointment.id %}" >
                  <i class="fa-regular fa-pen-to-square text-xl mr-2"></i>
                </a>

                <a href="#" onclick="openDeleteModal('{{ appointment.id }}')">
                  <i class="fa-solid fa-trash text-xl"></i>
                </a>             
              </th>
            </tr>
            
            {% endfor %}
          </tbody>
          
        </table>
        
      </div>

      

      <!-- Modal ลบ-->
      <div id="deleteModal" class="fixed inset-0 flex items-center justify-center z-50 hidden bg-gray-500 bg-opacity-50">
        <div class="bg-white p-6 rounded-lg shadow-lg w-1/3">
          <h3 class="text-xl font-semibold mb-4">ยืนยันการลบ</h3>
          <p>คุณต้องการลบการนัดหมายนี้หรือไม่?</p>
          <form id="deleteForm" method="POST">
            {% csrf_token %}
            <div class="mt-4 flex justify-end">
              <button type="button" class="btn btn-ghost mr-2" onclick="closeDeleteModal()">ยกเลิก</button>
              <button type="submit" class="btn btn-error">ลบ</button>
            </div>
          </form>
        </div>
      </div>


      <div class="flex justify-center mt-4">
        <nav class="btn-group">
            {% if page_obj.has_previous %}
            <a href="?page=1" class="btn btn-outline btn-sm">หน้าแรก</a>
            <a href="?page={{ page_obj.previous_page_number }}" class="btn btn-outline btn-sm">ก่อนหน้า</a>
            {% endif %}
    
            <span class="btn btn-disabled btn-sm">หน้า {{ page_obj.number }} จาก {{ page_obj.paginator.num_pages }}</span>
    
            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}" class="btn btn-outline btn-sm">ถัดไป</a>
            <a href="?page={{ page_obj.paginator.num_pages }}" class="btn btn-outline btn-sm">หน้าสุดท้าย</a>
            {% endif %}
        </nav>
     </div>
</div>
<script>
  // ลบบบบบ #####
  function openDeleteModal(appointmentId) {
    document.getElementById('deleteModal').classList.remove('hidden');
    document.getElementById('deleteForm').action = `/staff/appointment/delete/${appointmentId}/`; 
  }

  function closeDeleteModal() {
    document.getElementById('deleteModal').classList.add('hidden');
  }

  // เพิ่ม ######
  function openAddModal() {
    document.getElementById('addModal').classList.remove('hidden');
    document.getElementById('addForm').action = `/staff/appointment/add/`; 
  }

  function closeAddModal() {
    document.getElementById('addModal').classList.add('hidden');
  }
  /////////
  function updateTimeSlots() {
        var selectedDate = document.getElementById('date').value;
        var selectedDentist = document.getElementById('dentist').value;
        var timeSlotSelect = document.getElementById('time_slot');

        // ล้าง Time Slot เก่า
        timeSlotSelect.innerHTML = '<option value="">เลือกเวลา</option>';

        // ตรวจสอบว่ามีการเลือกทั้งวันที่และทันตแพทย์
        if (selectedDate && selectedDentist) {
            // ดึงข้อมูล Slot เวลาจาก Server โดยใช้ Ajax
            fetch(`/member/get-time-slots/?date=${selectedDate}&dentist_id=${selectedDentist}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.slots && data.slots.length > 0) {
                        data.slots.forEach(function(slot) {
                            var option = document.createElement('option');
                            option.value = slot;
                            option.textContent = slot;
                            timeSlotSelect.appendChild(option);
                        });
                    } else {
                        console.log("No slots available.");
                    }
                })
                .catch(error => {
                    console.error('Error fetching time slots:', error);
                });
        }
    }

    // เชื่อม Event กับ Date และ Dentist Dropdown
    document.getElementById('date').addEventListener('change', updateTimeSlots);
    document.getElementById('dentist').addEventListener('change', updateTimeSlots);
</script>
{% endblock %}

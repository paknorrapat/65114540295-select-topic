{% extends 'base.html' %}

{% block main %}
<div class="mt-8 flex flex-col justify-center items-center">    
    <div class="w-1/3">
        <div class=" bg-white p-8 rounded-lg shadow-lg w-full ">
            <p class="mb-3 text-xl text-center font-bold">ฟอร์มนัดหมาย</p>
            <form method="POST">
                {% csrf_token %}

                <label for="user">ชื่อคนไข้</label>
                <input type="text" id="user" name="name" value="{{appointment.user.title}}{{ appointment.user.first_name }} {{ appointment.user.last_name }}" readonly class="input input-bordered w-full  my-1" >
                <!-- ฟิลด์ hidden สำหรับส่งค่า user.id -->
                <input type="hidden" name="user" value="{{ appointment.user.id }}"> 

                <label for="dentist">ชื่อทันตแพทย์</label>
                <select id="dentist" name="dentist" required class="select select-bordered w-full max-w-xs my-1">
                    <option value="" disabled >เลือกทันตแพทย์</option> 
                    {% for dentist in dentists %}
                        <option value="{{ dentist.id }}" {% if dentist.id == appointment.dentist.id %}selected{% endif %}>{{ dentist.dentistName }}</option>
                    {% endfor %}
                </select>

                <label for="treatment">รายการนัดหมาย</label>
                <select type="text" id="treatment" name="treatment" required class="select select-bordered w-full  max-w-xs my-1" >
                    <option value="" disabled >เลือกรายการ</option> 
                        {% for treatment in treatments %}
                            <option value="{{treatment.id}}" {% if treatment.id == appointment.treatment.id %}selected{% endif %}>{{treatment.treatmentName}}</option>
                        {% endfor%}
                </select><br>

                <label for="date">วันที่นัดหมาย</label>
                <input type="date" id="date" name="date" value="{{ appointment.date|date:'Y-m-d' }}" class="input input-bordered w-full  max-w-xs my-1" />
            
                <!-- เพิ่ม Dropdown สำหรับ Time Slot -->
                <label for="time_slot">เวลา</label>
                <select id="time_slot" name="time_slot"  class="select select-bordered w-full  max-w-xs my-1">
                    <option value="">เลือกเวลา</option>
                    {% if appointment.time_slot %}
                        <option value="{{ appointment.time_slot }}" selected>{{ appointment.time_slot }}</option>
                    {% endif %}
                </select> <br>


                <div class="mt-3 ">
                    <button class="btn btn-neutral text-white mr-2" type="submit">บันทึกข้อมูล</button>
                    <a href="{% url 'member-home' %}" class="btn btn-ghost " >ยกเลิก</a>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    function updateTimeSlots() {
        var selectedDate = document.getElementById('date').value;
        var selectedDentist = document.getElementById('dentist').value;
        var timeSlotSelect = document.getElementById('time_slot');

        // ล้าง Time Slot เก่า
        timeSlotSelect.innerHTML = '<option value="">เลือกเวลา</option>';

        // ตรวจสอบว่ามีการเลือกทั้งวันที่และทันตแพทย์
        if (selectedDate && selectedDentist) {
            // ดึงข้อมูล Slot เวลาจาก Server โดยใช้ Ajax
            fetch(`/member/get-time-slots/?date=${selectedDate}&dentist_id=${selectedDentist}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.slots && data.slots.length > 0) {
                        data.slots.forEach(function(slot) {
                            var option = document.createElement('option');
                            option.value = slot;
                            option.textContent = slot;
                            timeSlotSelect.appendChild(option);
                        });

                        // ถ้ามีเวลาเดิมที่เลือกไว้จาก appointment ให้แสดงขึ้นมา
                        {% if appointment.time_slot %}
                            var selectedOption = document.createElement('option');
                            selectedOption.value = "{{ appointment.time_slot }}";
                            selectedOption.textContent = "{{ appointment.time_slot }}";
                            selectedOption.selected = true;
                            timeSlotSelect.prepend(selectedOption); // ให้เวลาที่เลือกแสดงที่ตำแหน่งแรก
                        {% endif %}
                    } else {
                        console.log("No slots available.");
                    }
                })
                .catch(error => {
                    console.error('Error fetching time slots:', error);
                });
        }
    }

    // เชื่อม Event กับ Date และ Dentist Dropdown
    document.getElementById('date').addEventListener('change', updateTimeSlots);
    document.getElementById('dentist').addEventListener('change', updateTimeSlots);

    // เมื่อหน้าโหลดให้โหลด slot เวลาทั้งหมด
    document.addEventListener('DOMContentLoaded', function() {
        updateTimeSlots();
    });
</script>
{% endblock %}
